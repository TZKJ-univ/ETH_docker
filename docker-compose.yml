version: '3.8'

services:
  geth:
    image: ethereum/client-go:stable
    container_name: geth-fullnode
    restart: unless-stopped
    volumes:
      - ./ethereum_data/geth:/root/.ethereum
      # jwtsecretはファイルなので、マウント先のディレクトリを事前に作成します
      - ./data:/root/.ethereum/jwt
    ports:
      - "30305:30303"        # p2p - ホスト側のポートを30305に変更
      - "30305:30303/udp"    # p2p discovery - ホスト側のポートを30305に変更
      - "8565:8545"          # RPC (HTTP) - ホスト側のポートを8565に変更
      - "8566:8546"          # WS - ホスト側のポートを8566に変更
      - "8552:8551"          # Auth RPC (Engine API) - ホスト側のポートを8552に変更
    command: [
      "--sepolia",           # Sepolia テストネットを使用
      "--http",
      "--http.addr", "0.0.0.0",
      "--http.api", "eth,net,web3,debug,engine",
      "--http.vhosts", "*",
      "--http.corsdomain", "*",
      "--ws",
      "--ws.addr", "0.0.0.0",
      "--ws.api", "eth,net,web3",
      "--syncmode", "snap",  # より高速な同期モード
      "--gcmode", "full",
      "--http.port", "8545",
      "--ws.port", "8546",
      "--authrpc.addr", "0.0.0.0",
      "--authrpc.port", "8551",
      "--authrpc.vhosts", "*",
      "--metrics",
      "--metrics.addr", "0.0.0.0",
      "--metrics.port", "6060",
      "--authrpc.jwtsecret", "/root/.ethereum/jwt/jwtsecret"
    ]
  
  beacon:
    image: sigp/lighthouse:latest
    container_name: lighthouse-beacon
    restart: unless-stopped
    depends_on:
      - geth
    volumes:
      - ./ethereum_data/beacon:/root/.lighthouse
      # jwtsecretはファイルなので、マウント先のディレクトリを事前に作成します
      - ./data:/root/.lighthouse/jwt
    ports:
      - "9001:9000/tcp"      # p2p - ホスト側のポートを9001に変更
      - "9001:9000/udp"      # p2p discovery - ホスト側のポートを9001に変更
      - "5052:5052"          # beacon API
    command:
      - lighthouse
      - bn
      - --network
      - sepolia
      - --datadir
      - /root/.lighthouse
      - --http
      - --http-address
      - 0.0.0.0
      - --http-port
      - "5052"
      - --execution-endpoint
      - http://geth:8551
      - --execution-jwt
      - /root/.lighthouse/jwt/jwtsecret
      - --checkpoint-sync-url
      - https://sepolia.checkpoint-sync.ethpandaops.io
      - --disable-deposit-contract-sync
      - --metrics
      - --metrics-address
      - 0.0.0.0
      - --metrics-port
      - "5054"
      - --port
      - "9000"
      - --discovery-port
      - "9000"
      - --target-peers
      - "50"
      - --subscribe-all-subnets
      - --import-all-attestations

# ホストマシンの D ドライブにデータを保存するため、Docker 管理ボリュームは使用しません
# volumes:
#   geth-data:
#   beacon-data:
