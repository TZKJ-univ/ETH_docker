version: '3.8'

services:
  geth:
    image: ethereum/client-go:stable
    container_name: geth-fullnode
    restart: unless-stopped
    volumes:
      - ./ethereum_data/geth:/root/.ethereum
      # jwtsecretはファイルなので、マウント先のディレクトリを事前に作成します
      - ./data:/root/.ethereum/jwt
    ports:
      - "30305:30303"        # p2p - ホスト側のポートを30305に変更
      - "30305:30303/udp"    # p2p discovery - ホスト側のポートを30305に変更
      - "8565:8545"          # RPC (HTTP) - ホスト側のポートを8565に変更
      - "8566:8546"          # WS - ホスト側のポートを8566に変更
      - "8552:8551"          # Auth RPC (Engine API) - ホスト側のポートを8552に変更
      - "6060:6060"          # Metrics
    command: [
      "--sepolia",           # Sepolia テストネットを使用
      "--http",
      "--http.addr", "0.0.0.0",
      "--http.api", "eth,net,web3,debug,engine",
      "--http.vhosts", "*",
      "--http.corsdomain", "*",
      "--ws",
      "--ws.addr", "0.0.0.0",
      "--ws.api", "eth,net,web3",
      "--syncmode", "snap",  # より高速な同期モード
      "--gcmode", "full",
      "--http.port", "8545",
      "--ws.port", "8546",
      "--authrpc.addr", "0.0.0.0",
      "--authrpc.port", "8551",
      "--authrpc.vhosts", "*",
      "--metrics",
      "--metrics.addr", "0.0.0.0",
      "--metrics.port", "6060",
      "--authrpc.jwtsecret", "/root/.ethereum/jwt/jwtsecret",
      "--ipcdisable"
    ]
    deploy:
      resources:
        limits:
          cpus: '6'
          memory: 16G
  
  beacon:
    image: prysmaticlabs/prysm-beacon-chain:stable
    container_name: prysm-beacon
    restart: unless-stopped
    depends_on:
      - geth
    volumes:
      - ./ethereum_data/beacon:/data
      - ./data:/data/jwt
    ports:
      - "9001:9000/tcp"      # p2p - ホスト側のポートを9001に変更
      - "9001:9000/udp"      # p2p discovery - ホスト側のポートを9001に変更
      - "5052:3500"          # Prysm HTTP API - ホスト側はLighthouseと同じ5052を使用
      - "5054:8080"          # Prysm Metrics - ホスト側はLighthouseと同じ5054を使用
    command:
      - --sepolia
      - --datadir=/data
      - --execution-endpoint=http://geth:8551
      - --jwt-secret=/data/jwt/jwtsecret
      - --checkpoint-sync-url=https://sepolia.checkpoint-sync.ethpandaops.io
      - --genesis-beacon-api-url=https://sepolia.checkpoint-sync.ethpandaops.io
      - --rpc-host=0.0.0.0
      - --grpc-gateway-host=0.0.0.0
      - --monitoring-host=0.0.0.0
      - --accept-terms-of-use
      - --p2p-tcp-port=9000
      - --p2p-udp-port=9000
      - --p2p-max-peers=50
      - --subscribe-all-subnets
    deploy:
      resources:
        limits:
          cpus: '6'
          memory: 16G

# ホストマシンの D ドライブにデータを保存するため、Docker 管理ボリュームは使用しません
# volumes:
#   geth-data:
#   beacon-data:
