version: '3.8'

services:
  geth:
    image: ethereum/client-go:stable
    container_name: geth-fullnode
    restart: unless-stopped
    volumes:
      - D:/ethereum_data_ephemery/geth:/root/.ethereum
      - ./ephemery_config:/config:ro
      # jwtsecretはファイルなので、マウント先のディレクトリを事前に作成します
      - ./data:/root/.ethereum/jwt
    ports:
      - "30305:30303"        # p2p - ホスト側のポートを30305に変更
      - "30305:30303/udp"    # p2p discovery - ホスト側のポートを30305に変更
      - "8565:8545"          # RPC (HTTP) - ホスト側のポートを8565に変更
      - "8566:8546"          # WS - ホスト側のポートを8566に変更
      - "8552:8551"          # Auth RPC (Engine API) - ホスト側のポートを8552に変更
      - "6060:6060"          # Metrics
    command: [
      # "--sepolia",           # Ephemery uses custom genesis
      "--http",
      "--http.addr", "0.0.0.0",
      "--http.api", "eth,net,web3,debug,engine",
      "--http.vhosts", "*",
      "--http.corsdomain", "*",
      "--ws",
      "--ws.addr", "0.0.0.0",
      "--ws.api", "eth,net,web3",
      "--syncmode", "full",  # Ephemery is small, full sync is fine
      "--gcmode", "full",
      "--http.port", "8545",
      "--ws.port", "8546",
      "--authrpc.addr", "0.0.0.0",
      "--authrpc.port", "8551",
      "--authrpc.vhosts", "*",
      "--metrics",
      "--metrics.addr", "0.0.0.0",
      "--metrics.port", "6060",
      "--authrpc.jwtsecret", "/root/.ethereum/jwt/jwtsecret",
      "--ipcdisable",
      "--maxpeers", "50",
      "--bootnodes", "${EPHEMERY_BOOTNODES_GETH}"
    ]
    deploy:
      resources:
        limits:
          cpus: '6'
          memory: 8G
  
  beacon:
    image: prysmaticlabs/prysm-beacon-chain:stable
    container_name: prysm-beacon
    restart: unless-stopped
    depends_on:
      - geth
    volumes:
      - D:/ethereum_data_ephemery/beacon:/data
      - ./ephemery_config:/config:ro
      - ./data:/data/jwt
    ports:
      - "9001:9000/tcp"      # p2p - ホスト側のポートを9001に変更
      - "9001:9000/udp"      # p2p discovery - ホスト側のポートを9001に変更
      - "5052:3500"          # Prysm HTTP API - ホスト側はLighthouseと同じ5052を使用
      - "5054:8080"          # Prysm Metrics - ホスト側はLighthouseと同じ5054を使用
    command:
      # - --sepolia            # Ephemery uses custom config
      - --datadir=/data
      - --execution-endpoint=http://geth:8551
      - --jwt-secret=/data/jwt/jwtsecret
      - --chain-config-file=/config/config.yaml
      - --genesis-state=/config/genesis.ssz
      - --bootstrap-node=enr:-MC4QN7Zf_vxLplW7lMPtbTxIL1hLqG6fq230Krca0Ej0TD2EF5fQIMCFN3uP-5KW630ctt08iHBXqzmGg9ymmu0kRkHh2F0dG5ldHOIAAAAAAAAABiDY2djBIRldGgykPE2bN9wABAbAAgAAAAAAACCaWSCdjSCaXCEiUrL8INuZmSEIVlFsolzZWNwMjU2azGhA2s2Gx8R9YM1HdhEPGjWGuxZMsK6kKlnAYwqjqs6EQF6g3RjcIIjjIN1ZHCCI4w
      - --bootstrap-node=enr:-Iq4QNMYHuJGbnXyBj6FPS2UkOQ-hnxT-mIdNMMr7evR9UYtLemaluorL6J10RoUG1V4iTPTEbl3huijSNs5_ssBWFiGAYhBNHOzgmlkgnY0gmlwhIlKy_CJc2VjcDI1NmsxoQNULnJBzD8Sakd9EufSXhM4rQTIkhKBBTmWVJUtLCp8KoN1ZHCCIyk
      - --bootstrap-node=enr:-Iq4QIc297-de1P6hznMX2cIdVsQkve9BD9NUsJ7vVQa7eh5UpekA9rLid5A-yLiS3gZwOGugYZPi58x76zNs2cEQFCGAYhBJlTYgmlkgnY0gmlwhEFtmi6Jc2VjcDI1NmsxoQJDyix-IHa_mVwLBEN9NeG8I-RUjNQK_MGxk9OqRQUAtIN1ZHCCIyg
      - --peer=enr:-MC4QN7Zf_vxLplW7lMPtbTxIL1hLqG6fq230Krca0Ej0TD2EF5fQIMCFN3uP-5KW630ctt08iHBXqzmGg9ymmu0kRkHh2F0dG5ldHOIAAAAAAAAABiDY2djBIRldGgykPE2bN9wABAbAAgAAAAAAACCaWSCdjSCaXCEiUrL8INuZmSEIVlFsolzZWNwMjU2azGhA2s2Gx8R9YM1HdhEPGjWGuxZMsK6kKlnAYwqjqs6EQF6g3RjcIIjjIN1ZHCCI4w
      - --peer=enr:-Iq4QNMYHuJGbnXyBj6FPS2UkOQ-hnxT-mIdNMMr7evR9UYtLemaluorL6J10RoUG1V4iTPTEbl3huijSNs5_ssBWFiGAYhBNHOzgmlkgnY0gmlwhIlKy_CJc2VjcDI1NmsxoQNULnJBzD8Sakd9EufSXhM4rQTIkhKBBTmWVJUtLCp8KoN1ZHCCIyk
      - --peer=enr:-Iq4QIc297-de1P6hznMX2cIdVsQkve9BD9NUsJ7vVQa7eh5UpekA9rLid5A-yLiS3gZwOGugYZPi58x76zNs2cEQFCGAYhBJlTYgmlkgnY0gmlwhEFtmi6Jc2VjcDI1NmsxoQJDyix-IHa_mVwLBEN9NeG8I-RUjNQK_MGxk9OqRQUAtIN1ZHCCIyg
      - --rpc-host=0.0.0.0
      - --grpc-gateway-host=0.0.0.0
      - --monitoring-host=0.0.0.0
      - --accept-terms-of-use
      - --p2p-tcp-port=9000
      - --p2p-udp-port=9000
      - --p2p-max-peers=50
      - --subscribe-all-subnets
      - --min-sync-peers=1
      - --suggested-fee-recipient=0xD63500725c1fB6b1bdA53416Ee62E65Bb46cd6cd
    deploy:
      resources:
        limits:
          cpus: '6'
          memory: 8G

  validator:
    image: prysmaticlabs/prysm-validator:stable
    container_name: prysm-validator
    restart: unless-stopped
    depends_on:
      - beacon
    volumes:
      - D:/ethereum_data_ephemery/validator:/data
      - ./ephemery_config:/config:ro
      - ./validator_keys:/keys:ro
    command:
      - --datadir=/data
      - --beacon-rpc-provider=beacon:4000
      - --chain-config-file=/config/config.yaml
      - --accept-terms-of-use
      - --wallet-dir=/data/wallet
      - --wallet-password-file=/data/password.txt
      - --suggested-fee-recipient=0xD63500725c1fB6b1bdA53416Ee62E65Bb46cd6cd
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 4G

# ホストマシンの D ドライブにデータを保存するため、Docker 管理ボリュームは使用しません
# volumes:
#   geth-data:
#   beacon-data:
